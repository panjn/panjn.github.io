<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>一文了解C程序是如何运行起来的 - 面向问题编程</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="面向问题编程"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="面向问题编程"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="分析C程序的预处理，编译，汇编，链接和运行过程。深入探究ELF文件格式，符号重定位过程和运行时内存模型。"><meta property="og:type" content="blog"><meta property="og:title" content="一文了解C程序是如何运行起来的"><meta property="og:url" content="https://www.heapoverflow.cn/pages/wiki-howcrun/"><meta property="og:site_name" content="面向问题编程"><meta property="og:description" content="分析C程序的预处理，编译，汇编，链接和运行过程。深入探究ELF文件格式，符号重定位过程和运行时内存模型。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.heapoverflow.cn/img/vector_landscape_1.svg"><meta property="article:published_time" content="2022-04-05T02:35:03.947Z"><meta property="article:modified_time" content="2022-04-05T02:43:35.022Z"><meta property="article:author" content="面向问题编程"><meta property="article:tag" content="编译原理"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/vector_landscape_1.svg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.heapoverflow.cn/pages/wiki-howcrun/"},"headline":"一文了解C程序是如何运行起来的","image":[],"datePublished":"2022-04-05T02:35:03.947Z","dateModified":"2022-04-05T02:43:35.022Z","author":{"@type":"Person","name":"面向问题编程"},"publisher":{"@type":"Organization","name":"面向问题编程","logo":{"@type":"ImageObject","url":"https://www.heapoverflow.cn/img/logo.svg"}},"description":"分析C程序的预处理，编译，汇编，链接和运行过程。深入探究ELF文件格式，符号重定位过程和运行时内存模型。"}</script><link rel="canonical" href="https://www.heapoverflow.cn/pages/wiki-howcrun/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-ETGL163DQH" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-ETGL163DQH');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-6757924689439593" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="面向问题编程" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/categories/%E9%97%AE%E9%A2%98/">问题</a><a class="navbar-item" href="/categories/%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84/">技术架构</a><a class="navbar-item" href="/categories/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3/">一文了解</a></div><div class="navbar-end"><a class="navbar-item" rel="noopener" title="分类" href="/categories">分类</a><a class="navbar-item" rel="noopener" title="标签" href="/tags">标签</a><a class="navbar-item" rel="noopener" title="归档" href="/archives">归档</a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/vector_landscape_1.svg" alt="一文了解C程序是如何运行起来的"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-04-05T02:35:03.947Z" title="2022/4/5 上午10:35:03">2022-04-05</time>发表</span><span class="level-item"><time dateTime="2022-04-05T02:43:35.022Z" title="2022/4/5 上午10:43:35">2022-04-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3/">一文了解</a></span><span class="level-item">39 分钟读完 (大约5796个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">一文了解C程序是如何运行起来的</h1><div class="content"><p>你用C语言写了个输出Hello world代码（为了分析一些东西，我加了各种类型的变量和函数）:</p>
<span id="more"></span>

<p>hello.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_int = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> static_int = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> extern_int;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">extern_func</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">global_func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">static_func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> var0 = global_int;</span><br><span class="line">    <span class="type">int</span> var1 = static_int;</span><br><span class="line">    <span class="type">int</span> var2 = extern_int;</span><br><span class="line">    <span class="type">int</span> var3 = extern_func();</span><br><span class="line">    <span class="type">int</span> var4 = global_func();</span><br><span class="line">    <span class="type">int</span> var5 = static_func();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>other.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> extern_int = <span class="number">3</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">extern_func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后”编译”, 其中-o指定了输出的文件名，默认为输出a.out</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.c</span><br><span class="line">gcc -c other.c</span><br><span class="line">gcc hello.o other.o -o hello</span><br></pre></td></tr></table></figure>

<p>这样你得到了Linux下的可执行文件hello, 它是ELF格式的。</p>
<p>最后运行，输出了Hello world</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./hello</span><br><span class="line">Hello world</span><br></pre></td></tr></table></figure>

<p>但从源代码hello.c生成可执行文件hello，再到运行hello输出Hello world, 其中具体发生了什么呢？</p>
<h2 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h2><p>我们先只看hello.c, other.c也要经过一样的步骤。</p>
<p>首先会对hello.c进行<em>预处理</em>(preprocess)，由于我们使用了头文件stdio.h, 这一步会做头文件展开（用头文件的内容替换掉include）</p>
<p>可以通过以下编译选项查看预处理后的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -E hello.c -o hello.i</span><br></pre></td></tr></table></figure>

<p>hello.i的后40行内容是这样的(tail hello.i -n 40)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">e# <span class="number">912</span> <span class="string">&quot;/usr/include/stdio.h&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">flockfile</span> <span class="params">(FILE *__stream)</span> __<span class="title function_">attribute__</span> <span class="params">((__nothrow__ , __leaf__))</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">ftrylockfile</span> <span class="params">(FILE *__stream)</span> __<span class="title function_">attribute__</span> <span class="params">((__nothrow__ , __leaf__))</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">funlockfile</span> <span class="params">(FILE *__stream)</span> __<span class="title function_">attribute__</span> <span class="params">((__nothrow__ , __leaf__))</span>;</span><br><span class="line"># <span class="number">942</span> <span class="string">&quot;/usr/include/stdio.h&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"># <span class="number">2</span> <span class="string">&quot;hello.c&quot;</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="number">3</span> <span class="string">&quot;hello.c&quot;</span></span><br><span class="line"><span class="type">int</span> global_int = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> static_int = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> extern_int;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">extern_func</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">global_func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">static_func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> var0 = global_int;</span><br><span class="line">    <span class="type">int</span> var1 = static_int;</span><br><span class="line">    <span class="type">int</span> var2 = extern_int;</span><br><span class="line">    <span class="type">int</span> var3 = extern_func();</span><br><span class="line">    <span class="type">int</span> var4 = global_func();</span><br><span class="line">    <span class="type">int</span> var5 = static_func();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>预处理之后，我们通过<em>编译</em>(compile)，从hello.i生成汇编代码hello.s</p>
<p>这里如果展开说的话，就是编译原理那一套了：词法分析、语法分析、语义分析、生成中间代码和优化，最后生成目标代码（这里是汇编代码hello.s）</p>
<p>先直接看下生成的汇编代码, 运行<code>gcc -S hello.i</code>得到hello.s：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">        .file   &quot;hello.c&quot;</span><br><span class="line">        .globl  global_int</span><br><span class="line">        .data</span><br><span class="line">        .align 4</span><br><span class="line">        .type   global_int, @object</span><br><span class="line">        .size   global_int, 4</span><br><span class="line">global_int:</span><br><span class="line">        .long   1</span><br><span class="line">        .align 4</span><br><span class="line">        .type   static_int, @object</span><br><span class="line">        .size   static_int, 4</span><br><span class="line">static_int:</span><br><span class="line">        .long   2</span><br><span class="line">        .text</span><br><span class="line">        .globl  global_func</span><br><span class="line">        .type   global_func, @function</span><br><span class="line">global_func:</span><br><span class="line">.LFB0:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushq   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset 6, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">        .cfi_def_cfa_register 6</span><br><span class="line">        movl    $3, %eax</span><br><span class="line">        popq    %rbp</span><br><span class="line">        .cfi_def_cfa 7, 8</span><br><span class="line">        ret</span><br><span class="line">        .cfi_endproc</span><br><span class="line">.LFE0:</span><br><span class="line">        .size   global_func, .-global_func</span><br><span class="line">        .type   static_func, @function</span><br><span class="line">static_func:</span><br><span class="line">.LFB1:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushq   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset 6, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">        .cfi_def_cfa_register 6</span><br><span class="line">        movl    $4, %eax</span><br><span class="line">        popq    %rbp</span><br><span class="line">        .cfi_def_cfa 7, 8</span><br><span class="line">        ret</span><br><span class="line">        .cfi_endproc</span><br><span class="line">.LFE1:</span><br><span class="line">        .size   static_func, .-static_func</span><br><span class="line">        .section        .rodata</span><br><span class="line">.LC0:</span><br><span class="line">        .string &quot;Hello World&quot;</span><br><span class="line">        .text</span><br><span class="line">        .globl  main</span><br><span class="line">        .type   main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB2:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushq   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset 6, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">        .cfi_def_cfa_register 6</span><br><span class="line">        subq    $32, %rsp</span><br><span class="line">        movl    global_int(%rip), %eax</span><br><span class="line">        movl    %eax, -24(%rbp)</span><br><span class="line">        movl    static_int(%rip), %eax</span><br><span class="line">        movl    %eax, -20(%rbp)</span><br><span class="line">        movl    extern_int(%rip), %eax</span><br><span class="line">        movl    %eax, -16(%rbp)</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">        call    extern_func</span><br><span class="line">        movl    %eax, -12(%rbp)</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">        call    global_func</span><br><span class="line">        movl    %eax, -8(%rbp)</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">        call    static_func</span><br><span class="line">        movl    %eax, -4(%rbp)</span><br><span class="line">        movl    $.LC0, %edi</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">        call    printf</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">        leave</span><br><span class="line">        .cfi_def_cfa 7, 8</span><br><span class="line">        ret</span><br><span class="line">        .cfi_endproc</span><br><span class="line">.LFE2:</span><br><span class="line">        .size   main, .-main</span><br><span class="line">        .ident  &quot;GCC: (Ubuntu 5.4.0-6ubuntu1~16.04.12) 5.4.0 20160609&quot;</span><br><span class="line">        .section        .note.GNU-stack,&quot;&quot;,@progbits</span><br></pre></td></tr></table></figure>

<h3 id="汇编代码分析"><a href="#汇编代码分析" class="headerlink" title="汇编代码分析"></a>汇编代码分析</h3><p>我们分析下main函数的汇编代码（先忽略掉.cfi那些东西）：</p>
<p>首先说明rsp是堆栈指针寄存器(stack pointer)，指向栈顶位置。rbp是栈帧指针寄存器(frame pointer), 标识当前栈帧的起始位置（每个函数调用都有一个栈帧，栈是一个个栈帧叠起来的）。</p>
<ul>
<li>第57行<code>pushq %rbp</code>就是将rbp的值入栈，相当于<code>subq $8, $rsp</code>再<code>moveq $rbp, $rsp</code>. 即先将栈顶地址减去8字节，再把rbp寄存器放到这8字节的内存里。 这里q的意思是64位。</li>
<li>第60行<code>movq %rsp, %rbp</code>就是将当前的栈顶地址作为新的栈帧地址。</li>
<li>第62行<code>subq $32, %rsp</code>即将栈顶地址减去32字节，以便把后面的局部遍历放进来。为什么是32字节，因为后面有6个int,一共24字节，这里按16的倍数对齐，所以减去了32字节。这里的计算说明，放在栈（说白了也就是通过栈寄存器来操作的某块内存）上的东西得在编译时知道大小。</li>
<li>第63行<code>movl global_int(%rip), %eax</code>的意思是通过rip相对寻址来将global_int的值放到eax寄存器。
rip存储的是下一条指令的地址。后面在汇编那部分再解释。</li>
<li>第64行即<code>movl %eax, -24(%rbp)</code>就是把寄存器eax的值放到栈帧起始地址再减去24字节的那个地址。如此便完成了把局部遍历var0入栈的过程，它的值等于global_int的值。它的地址是<code>-24(%rbp)</code></li>
<li>第65到80行类似，只不过暂时不知道为啥call指令之前都有<code>move $0, %eax</code>。注意，call之后整数返回值存在eax寄存器，所以我们call之后会将eax的值入栈，完成源代码(hello.c)第35到37行的局部变量赋值过程。</li>
<li>第81行是将main的返回值0放进eax寄存器。</li>
<li>第82行leave就是main一开始的<code>pushq %rbp</code>和<code>moveq %rsp, %rbp</code>的反向操作。即先通过<code>moveq $rbp, %rsp</code>
令栈顶指针等于栈帧指针，再将一开始push进去的rbp取出来作为新的栈帧指针（这样就恢复到了调用main之前的栈帧起始地址）, 然后rsp加8字节（这样就恢复到了原来的栈顶地址)。</li>
<li>第84行ret是和call指令相对的，call会将调用新函数前的地址入栈，而ret则是将这个地址出栈，以便回到原来的地方继续执行。</li>
</ul>
<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><p>这里我们将上面汇编代码(文本文件hello.s)生成ELF格式的二进制文件(hello.o)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.s -g</span><br></pre></td></tr></table></figure>
<p>-g是生成调试信息，这样反编译hello.o时才能和原来的hello.s对照着看（如果想和hello.c对照着看，则跑<code>gcc -c hello.c -g</code>）。</p>
<h3 id="ELF格式"><a href="#ELF格式" class="headerlink" title="ELF格式"></a>ELF格式</h3><p>ELF格式文件有特定的布局：</p>
<p><img src="/img/my/elf-layout.png" alt="ELF格式文件布局"></p>
<p>ELF Header中有开头的magic number <code>0x7c454c46</code>，表示这是一个ELF文件，其中45 4c 46分别对应ELF三个字母的ASCII码。其它一些字节记录了program header table和section header table在哪个位置，ELF版本，操作系统ABI类型等。 在ELF被载入内存运行前，我们从section的视角看它，比如上面有.text, .rodata, .data段(section)。section header table就是描述这些section的位置和性质的。而program header描述的是将ELF后载入内存后在内存中分成的一些segment。</p>
<p>通过<code>readelf -h hello.o</code>可以解析ELF Header:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2&#x27;s complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              REL (Relocatable file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x0</span><br><span class="line">  Start of program headers:          0 (bytes into file)</span><br><span class="line">  Start of section headers:          3200 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               64 (bytes)</span><br><span class="line">  Size of program headers:           0 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         21</span><br><span class="line">  Section header string table index: 18</span><br></pre></td></tr></table></figure>

<p>注意到它的Type是Relocatable file（可重定位文件）以及<code>Size of program headers:           0 (bytes)</code>,即这个ELF文件没有program header(可以通过
readelf -l hello.o查看program headers).</p>
<p>通过<code>readelf -S hello.o</code>可以查看section headers:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       0000000000000076  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000798</span><br><span class="line">       00000000000000a8  0000000000000018   I      19     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  000000b8</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  000000c0</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 5] .rodata           PROGBITS         0000000000000000  000000c0</span><br><span class="line">       000000000000000c  0000000000000000   A       0     0     1</span><br><span class="line">  [ 6] .debug_info       PROGBITS         0000000000000000  000000cc</span><br><span class="line">       0000000000000159  0000000000000000           0     0     1</span><br><span class="line">  [ 7] .rela.debug_info  RELA             0000000000000000  00000840</span><br><span class="line">       0000000000000300  0000000000000018   I      19     6     8</span><br><span class="line">  [ 8] .debug_abbrev     PROGBITS         0000000000000000  00000225</span><br><span class="line">       00000000000000a3  0000000000000000           0     0     1</span><br><span class="line">  [ 9] .debug_aranges    PROGBITS         0000000000000000  000002c8</span><br><span class="line">       0000000000000030  0000000000000000           0     0     1</span><br><span class="line">  [10] .rela.debug_arang RELA             0000000000000000  00000b40</span><br><span class="line">       0000000000000030  0000000000000018   I      19     9     8</span><br><span class="line">  [11] .debug_line       PROGBITS         0000000000000000  000002f8</span><br><span class="line">       0000000000000048  0000000000000000           0     0     1</span><br><span class="line">  [12] .rela.debug_line  RELA             0000000000000000  00000b70</span><br><span class="line">       0000000000000018  0000000000000018   I      19    11     8</span><br><span class="line">  [13] .debug_str        PROGBITS         0000000000000000  00000340</span><br><span class="line">       0000000000000137  0000000000000001  MS       0     0     1</span><br><span class="line">  [14] .comment          PROGBITS         0000000000000000  00000477</span><br><span class="line">       0000000000000036  0000000000000001  MS       0     0     1</span><br><span class="line">  [15] .note.GNU-stack   PROGBITS         0000000000000000  000004ad</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [16] .eh_frame         PROGBITS         0000000000000000  000004b0</span><br><span class="line">       0000000000000078  0000000000000000   A       0     0     8</span><br><span class="line">  [17] .rela.eh_frame    RELA             0000000000000000  00000b88</span><br><span class="line">       0000000000000048  0000000000000018   I      19    16     8</span><br><span class="line">  [18] .shstrtab         STRTAB           0000000000000000  00000bd0</span><br><span class="line">       00000000000000b0  0000000000000000           0     0     1</span><br><span class="line">  [19] .symtab           SYMTAB           0000000000000000  00000528</span><br><span class="line">       0000000000000210  0000000000000018          20    16     8</span><br><span class="line">  [20] .strtab           STRTAB           0000000000000000  00000738</span><br><span class="line">       000000000000005a  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure>

<h3 id="分析-text段的内容"><a href="#分析-text段的内容" class="headerlink" title="分析.text段的内容"></a>分析.text段的内容</h3><p>我们通过objdump反编译hello.o来查看.text段(section)的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -S hello.o</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hello.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;global_func&gt;:</span><br><span class="line">        .globl  global_func</span><br><span class="line">        .type   global_func, @function</span><br><span class="line">global_func:</span><br><span class="line">.LFB0:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushq   %rbp</span><br><span class="line">   0:   55                      push   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset 6, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">   1:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">        .cfi_def_cfa_register 6</span><br><span class="line">        movl    $3, %eax</span><br><span class="line">   4:   b8 03 00 00 00          mov    $0x3,%eax</span><br><span class="line">        popq    %rbp</span><br><span class="line">   9:   5d                      pop    %rbp</span><br><span class="line">        .cfi_def_cfa 7, 8</span><br><span class="line">        ret</span><br><span class="line">   a:   c3                      retq</span><br><span class="line"></span><br><span class="line">000000000000000b &lt;static_func&gt;:</span><br><span class="line">        .size   global_func, .-global_func</span><br><span class="line">        .type   static_func, @function</span><br><span class="line">static_func:</span><br><span class="line">.LFB1:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushq   %rbp</span><br><span class="line">   b:   55                      push   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset 6, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">   c:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">        .cfi_def_cfa_register 6</span><br><span class="line">        movl    $4, %eax</span><br><span class="line">   f:   b8 04 00 00 00          mov    $0x4,%eax</span><br><span class="line">        popq    %rbp</span><br><span class="line">  14:   5d                      pop    %rbp</span><br><span class="line">        .cfi_def_cfa 7, 8</span><br><span class="line">        ret</span><br><span class="line">  15:   c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000000016 &lt;main&gt;:</span><br><span class="line">        .globl  main</span><br><span class="line">        .type   main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB2:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushq   %rbp</span><br><span class="line">  16:   55                      push   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset 6, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">  17:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">        .cfi_def_cfa_register 6</span><br><span class="line">        subq    $32, %rsp</span><br><span class="line">  1a:   48 83 ec 20             sub    $0x20,%rsp</span><br><span class="line">        movl    global_int(%rip), %eax</span><br><span class="line">  1e:   8b 05 00 00 00 00       mov    0x0(%rip),%eax        # 24 &lt;main+0xe&gt;</span><br><span class="line">        movl    %eax, -24(%rbp)</span><br><span class="line">  24:   89 45 e8                mov    %eax,-0x18(%rbp)</span><br><span class="line">        movl    static_int(%rip), %eax</span><br><span class="line">  27:   8b 05 00 00 00 00       mov    0x0(%rip),%eax        # 2d &lt;main+0x17&gt;</span><br><span class="line">        movl    %eax, -20(%rbp)</span><br><span class="line">  2d:   89 45 ec                mov    %eax,-0x14(%rbp)</span><br><span class="line">        movl    extern_int(%rip), %eax</span><br><span class="line">  30:   8b 05 00 00 00 00       mov    0x0(%rip),%eax        # 36 &lt;main+0x20&gt;</span><br><span class="line">        movl    %eax, -16(%rbp)</span><br><span class="line">  36:   89 45 f0                mov    %eax,-0x10(%rbp)</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">  39:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">        call    extern_func</span><br><span class="line">  3e:   e8 00 00 00 00          callq  43 &lt;main+0x2d&gt;</span><br><span class="line">        movl    %eax, -12(%rbp)</span><br><span class="line">  43:   89 45 f4                mov    %eax,-0xc(%rbp)</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">  46:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">        call    global_func</span><br><span class="line">  4b:   e8 00 00 00 00          callq  50 &lt;main+0x3a&gt;</span><br><span class="line">        movl    %eax, -8(%rbp)</span><br><span class="line">  50:   89 45 f8                mov    %eax,-0x8(%rbp)</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">  53:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">        call    static_func</span><br><span class="line">  58:   e8 ae ff ff ff          callq  b &lt;static_func&gt;</span><br><span class="line">        movl    %eax, -4(%rbp)</span><br><span class="line">  5d:   89 45 fc                mov    %eax,-0x4(%rbp)</span><br><span class="line">        movl    $.LC0, %edi</span><br><span class="line">  60:   bf 00 00 00 00          mov    $0x0,%edi</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">  65:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">        call    printf</span><br><span class="line">  6a:   e8 00 00 00 00          callq  6f &lt;main+0x59&gt;</span><br><span class="line">        movl    $0, %eax</span><br><span class="line">  6f:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">        leave</span><br><span class="line">  74:   c9                      leaveq</span><br><span class="line">        .cfi_def_cfa 7, 8</span><br><span class="line">        ret</span><br><span class="line">  75:   c3                      retq</span><br></pre></td></tr></table></figure>

<h4 id="rip相对寻址"><a href="#rip相对寻址" class="headerlink" title="rip相对寻址"></a>rip相对寻址</h4><p>我们在之前提到了global_int的rip相对寻址，这里我们看下它对应被翻译成了什么。
看第64到67行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      movl    global_int(%rip), %eax</span><br><span class="line">1e:   8b 05 00 00 00 00       mov    0x0(%rip),%eax        # 24 &lt;main+0xe&gt;</span><br><span class="line">      movl    %eax, -24(%rbp)</span><br><span class="line">24:   89 45 e8                mov    %eax,-0x18(%rbp)</span><br></pre></td></tr></table></figure>
<p>它被翻译成了二进制<code>8b 05 00 00 00 00</code>, 汇编的意思是<code> mov 0x0(%rip), %eax</code>, <code>0x0(%rip)</code>的
意思是相对rip的偏移是0，而这里rip（下一条指令的地址）是0x24，所以它的意思就是将地址0x24的值放到eax寄存器。
但是，显然global_int并不在0x24这个地址呀，这个地址放的是二进制<code>89 45 e8 ...</code>,即指令<code>mov %eax,-0x18(%rbp)</code>（注意这里反汇编出来的rbp相对寻址用的16进制表示，-0x18等于10进制的-24）。 实际上这个0x0只是个占位符，在汇编这一步骤里，我们还无法确定global_int的最终地址。因为后面我们会将hello.o和other.o进行链接，然后生成最终的可执行文件，这一步可能会导致全局变量的地址发生变化。</p>
<p>而extern声明的变量extern_int和函数extern_func显然就更无法确定了，所以也是先填个0x0. 比如
<code>call  extern_func</code>被翻译成了<code>e8 00 00 00 00</code>, e8是call指令，后面0是操作数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    call    extern_func</span><br><span class="line">3e:   e8 00 00 00 00          callq  43 &lt;main+0x2d&gt;</span><br><span class="line">      movl    %eax, -12(%rbp)</span><br><span class="line">43:   89 45 f4                mov    %eax,-0xc(%rbp)</span><br></pre></td></tr></table></figure>

<p>实际上，上面的局部变量，全局变量，静态变量，静态函数，外部变量和外部函数，除了局部变量基于rbp寻址外，
在这一阶段只有静态函数可以确定相对地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      call    static_func</span><br><span class="line">58:   e8 ae ff ff ff          callq  b &lt;static_func&gt;</span><br><span class="line">      movl    %eax, -4(%rbp)</span><br><span class="line">5d:   89 45 fc                mov    %eax,-0x4(%rbp)</span><br></pre></td></tr></table></figure>
<p><code>call  static_func</code>被翻译成了二进制<code>e8 ae ff ff ff</code>，e8是call指令，
<code>ae ff ff ff</code>是相对地址，这里应该用小端字节序来看(低位字节放在高位地址)。0xffffffae就是十进制的-82。</p>
<p>在这里而言此时rip(下一条指令地址)是0x5d, <code>0x5d-82=5*16+13-82=11=0xb</code>，而0xb刚好是static_func在hello.o中的地址。</p>
<p>注意，这里并不意味着链接后最终的可执行文件中static_func的地址也会是0xb. 这里可以确定的是最终的可执行文件中，
<code>call static_func</code>的下一条指令和static_func的相对地址(0xffffffae)是不变的，这对于rip相对寻址来说就够了。</p>
<p>而后面的阶段就得处理那些用0x0占位了的地方，这就是重定位。</p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.c -o hello.o -g</span><br><span class="line">gcc -c other.c -o other.o -g</span><br><span class="line">gcc hello.o other.o -o hello</span><br></pre></td></tr></table></figure>
<p>链接的时候，会把hello.o和other.o的各个section分别合并，比如.text段和.text段合并。</p>
<p>我们先看下最终生成的可执行文件hello. 运行<code>objdump -S hello</code>解析它的内容，下面是部分内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">  40053c:       55                      push   %rbp</span><br><span class="line">  40053d:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  400540:       48 83 ec 20             sub    $0x20,%rsp</span><br><span class="line">    int var0 = global_int;</span><br><span class="line">  400544:       8b 05 ee 0a 20 00       mov    0x200aee(%rip),%eax        # 601038 &lt;global_int&gt;</span><br><span class="line">  40054a:       89 45 e8                mov    %eax,-0x18(%rbp)</span><br><span class="line">    int var1 = static_int;</span><br><span class="line">  40054d:       8b 05 e9 0a 20 00       mov    0x200ae9(%rip),%eax        # 60103c &lt;static_int&gt;</span><br><span class="line">  400553:       89 45 ec                mov    %eax,-0x14(%rbp)</span><br><span class="line">    int var2 = extern_int;</span><br><span class="line">  400556:       8b 05 e4 0a 20 00       mov    0x200ae4(%rip),%eax        # 601040 &lt;extern_int&gt;</span><br><span class="line">  40055c:       89 45 f0                mov    %eax,-0x10(%rbp)</span><br><span class="line">    int var3 = extern_func();</span><br><span class="line">  40055f:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  400564:       e8 33 00 00 00          callq  40059c &lt;extern_func&gt;</span><br><span class="line">  400569:       89 45 f4                mov    %eax,-0xc(%rbp)</span><br><span class="line">    int var4 = global_func();</span><br><span class="line">  40056c:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  400571:       e8 b0 ff ff ff          callq  400526 &lt;global_func&gt;</span><br><span class="line">  400576:       89 45 f8                mov    %eax,-0x8(%rbp)</span><br><span class="line">    int var5 = static_func();</span><br><span class="line">  400579:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  40057e:       e8 ae ff ff ff          callq  400531 &lt;static_func&gt;</span><br><span class="line">  400583:       89 45 fc                mov    %eax,-0x4(%rbp)</span><br><span class="line">        printf(&quot;Hello world&quot;);</span><br><span class="line">  400586:       bf 34 06 40 00          mov    $0x400634,%edi</span><br><span class="line">  40058b:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  400590:       e8 6b fe ff ff          callq  400400 &lt;printf@plt&gt;</span><br><span class="line">    return 0;</span><br><span class="line">  400595:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">&#125;</span><br><span class="line">  40059a:       c9                      leaveq</span><br><span class="line">  40059b:       c3                      retq</span><br><span class="line"></span><br><span class="line">000000000040059c &lt;extern_func&gt;:</span><br><span class="line">int extern_int = 3;</span><br><span class="line">int extern_func() &#123;</span><br><span class="line">  40059c:       55                      push   %rbp</span><br><span class="line">  40059d:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    return 10;</span><br><span class="line">  4005a0:       b8 0a 00 00 00          mov    $0xa,%eax</span><br><span class="line">&#125;</span><br><span class="line">  4005a5:       5d                      pop    %rbp</span><br><span class="line">  4005a6:       c3                      retq</span><br><span class="line">  4005a7:       66 0f 1f 84 00 00 00    nopw   0x0(%rax,%rax,1)</span><br><span class="line">  4005ae:       00 00</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="分析重定位信息"><a href="#分析重定位信息" class="headerlink" title="分析重定位信息"></a>分析重定位信息</h3><p>以extern_func为例，上面第18行中，我们之前hello.s中用0x0占位的操作数变成了0x00003。为什么是0x000033？
用rip相对寻址的话，因为下一条指令是0x400569，extern_func的地址是0x40059c, <code>0x400569+0x000033= 0x40059c</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">400564:       e8 33 00 00 00          callq  40059c &lt;extern_func&gt;</span><br><span class="line">400569:       89 45 f4                mov    %eax,-0xc(%rbp)</span><br></pre></td></tr></table></figure>

<h3 id="rela-text段"><a href="#rela-text段" class="headerlink" title=".rela.text段"></a>.rela.text段</h3><p>实际上，hello.o中哪些符号需要重定位是记录在.rela开头的section中的。.rela.text段就记录了hello.o的.text段
需要重定位的地方和重定位类型等。</p>
<p>通过<code>readelf -r hello.o</code>可以输出hello.o的和重定位有关的section的内容, 这里我们只看.rela.text段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Relocation section &#x27;.rela.text&#x27; at offset 0x798 contains 7 entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000020  001000000002 R_X86_64_PC32     0000000000000000 global_int - 4</span><br><span class="line">000000000029  000300000002 R_X86_64_PC32     0000000000000000 .data + 0</span><br><span class="line">000000000032  001300000002 R_X86_64_PC32     0000000000000000 extern_int - 4</span><br><span class="line">00000000003f  001400000002 R_X86_64_PC32     0000000000000000 extern_func - 4</span><br><span class="line">00000000004c  001100000002 R_X86_64_PC32     0000000000000000 global_func - 4</span><br><span class="line">000000000061  00070000000a R_X86_64_32       0000000000000000 .rodata + 0</span><br><span class="line">00000000006b  001500000002 R_X86_64_PC32     0000000000000000 printf - 4</span><br></pre></td></tr></table></figure>

<h4 id="rela-text段的offset字段"><a href="#rela-text段的offset字段" class="headerlink" title=".rela.text段的offset字段"></a>.rela.text段的offset字段</h4><p>在之前<a href="#%E5%88%86%E6%9E%90-text%E6%AE%B5%E7%9A%84%E5%86%85%E5%AE%B9">分析.text段内容</a>时, <code>call extern_func</code>在.text段内的偏移是0x3e, 
这个地方指令是0xe800000000, 其中代表call的0xe8占了一个字节，因此0x3e得加上一个字节得到0x3f, 0x3f这个地方就是我们要重定位的那个符号(extern_func)在hello.o的text段内的offset。
所以上面第6行这个重定位项的offset字段的值正是0x3f。</p>
<h4 id="rela-text段的info字段"><a href="#rela-text段的info字段" class="headerlink" title=".rela.text段的info字段"></a>.rela.text段的info字段</h4><p>而Info字段的值表示什么呢？0x001400000002要拆开看，0x00000002是表示Type为R_X86_64_PC32。0x0014是符号表的index. 0x14就是20， 即.systab的第21个条目就记录了这个符号的信息。上面的.rela.text段的sym.value和sym.name就是根据索引这这里读出来显示的。值得一提的是，.symtab的Name字段本身存的又是一个在.strtab段内的偏移，它根据这个偏移去.strtab找到真正的名字字符串。.symtab的value字段（对hello.o(可重定位目标文件)来说）记录的是这个符号的段内偏移。比如main是在hello.o的.text段的0x16偏移处。</p>
<p>通过<code>realelf -s hello.o</code>查看符号表(.symtab段)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Symbol table &#x27;.symtab&#x27; contains 22 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS hello.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 0000000000000004     4 OBJECT  LOCAL  DEFAULT    3 static_int</span><br><span class="line">     6: 000000000000000b    11 FUNC    LOCAL  DEFAULT    1 static_func</span><br><span class="line">     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    8</span><br><span class="line">    10: 0000000000000000     0 SECTION LOCAL  DEFAULT    9</span><br><span class="line">    11: 0000000000000000     0 SECTION LOCAL  DEFAULT   11</span><br><span class="line">    12: 0000000000000000     0 SECTION LOCAL  DEFAULT   13</span><br><span class="line">    13: 0000000000000000     0 SECTION LOCAL  DEFAULT   15</span><br><span class="line">    14: 0000000000000000     0 SECTION LOCAL  DEFAULT   16</span><br><span class="line">    15: 0000000000000000     0 SECTION LOCAL  DEFAULT   14</span><br><span class="line">    16: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    3 global_int</span><br><span class="line">    17: 0000000000000000    11 FUNC    GLOBAL DEFAULT    1 global_func</span><br><span class="line">    18: 0000000000000016    96 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">    19: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND extern_int</span><br><span class="line">    20: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND extern_func</span><br><span class="line">    21: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND printf</span><br></pre></td></tr></table></figure>

<h4 id="rela-text段的Attend字段"><a href="#rela-text段的Attend字段" class="headerlink" title=".rela.text段的Attend字段"></a>.rela.text段的Attend字段</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">     call    extern_func</span><br><span class="line">3e:   e8 00 00 00 00          callq  43 &lt;main+0x2d&gt;</span><br></pre></td></tr></table></figure>
<p>上面的Addend&#x3D;-4起始表示的是要重定位的那个地址和rip的差，对于<code>call extern_func</code>,由于要重定位的操作数是4字节的，它与下一条指令地址的值自然是相差-4字节。</p>
<p>R_X86_64_PC32这种类型的重定位公式 S-%rip 通常被分解为 S-(P-A) &#x3D; S+A-P</p>
<ul>
<li>S就是call extern_func在hello中的地址0x400564</li>
<li>A就是Addend&#x3D;-4</li>
<li>P就是hello中要重定位的地址<code>0x400569 - 4</code></li>
</ul>
<p>值得一提的是，像地址0x400564并不是指call extern_func这个指令在文件的第0x400564字节处，实际上它是在第0x564字节处。</p>
<p>实际上我们可以通过<code>readelf -l hello</code>看programm headers:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Elf file type is EXEC (Executable file)</span><br><span class="line">Entry point 0x400430</span><br><span class="line">There are 9 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  PHDR           0x0000000000000040 0x0000000000400040 0x0000000000400040</span><br><span class="line">                 0x00000000000001f8 0x00000000000001f8  R E    8</span><br><span class="line">  INTERP         0x0000000000000238 0x0000000000400238 0x0000000000400238</span><br><span class="line">                 0x000000000000001c 0x000000000000001c  R      1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000</span><br><span class="line">                 0x00000000000007e4 0x00000000000007e4  R E    200000</span><br><span class="line">  LOAD           0x0000000000000e10 0x0000000000600e10 0x0000000000600e10</span><br><span class="line">                 0x0000000000000234 0x0000000000000238  RW     200000</span><br><span class="line">  DYNAMIC        0x0000000000000e28 0x0000000000600e28 0x0000000000600e28</span><br><span class="line">                 0x00000000000001d0 0x00000000000001d0  RW     8</span><br><span class="line">  NOTE           0x0000000000000254 0x0000000000400254 0x0000000000400254</span><br><span class="line">                 0x0000000000000044 0x0000000000000044  R      4</span><br><span class="line">  GNU_EH_FRAME   0x0000000000000640 0x0000000000400640 0x0000000000400640</span><br><span class="line">                 0x000000000000004c 0x000000000000004c  R      4</span><br><span class="line">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">                 0x0000000000000000 0x0000000000000000  RW     10</span><br><span class="line">  GNU_RELRO      0x0000000000000e10 0x0000000000600e10 0x0000000000600e10</span><br><span class="line">                 0x00000000000001f0 0x00000000000001f0  R      1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00</span><br><span class="line">   01     .interp</span><br><span class="line">   02     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .plt.got .text .fini .rodata .eh_frame_hdr .eh_frame</span><br><span class="line">   03     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss</span><br><span class="line">   04     .dynamic</span><br><span class="line">   05     .note.ABI-tag .note.gnu.build-id</span><br><span class="line">   06     .eh_frame_hdr</span><br><span class="line">   07</span><br><span class="line">   08     .init_array .fini_array .jcr .dynamic .got</span><br></pre></td></tr></table></figure>
<p>上面第一个LOAD类型条目就描述了将ELF从0x0开始，大小为0x7e4的内容映射到虚拟内存地址为0x400000(这是64位Linux系统默认的加载地址，32位系统是0x08048000)，大小为0x7e4的地方，注意最下面的section to segment mapping, 这块地方实际上包含了很多section(.text等)，它门在内存中对应一个segment.</p>
<p>第二个LOAD条目又描述了另一个segment(.data, .bss等)，它对应的是另一些sections.</p>
<p>所以实际上0x400564是0x400000加上0x564得到的。</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>经过上面说的预处理，编译，汇编，（静态）链接后，你有了一个ELF格式的可执行文件hello。可以在shell中输入<code>./hello</code>运行。</p>
<h3 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h3><p>此时会fork一个进程出来，操作系统为每个进程提供了一个进程管理的结果，被称为进程控制块(Process control Block, PCB)，在Linux系统上，
它就是task_struct这个结构体。它记录了进程id, 打开文件列表，进程调度，运行统计和内存管理等信息。
跟内存管理相关其中一个变量是<code>struct mm_struct *mm;</code>, 其中mm_struct中又有一个<code>vm_area_struct*</code>指针和页表目录指针<code>pgd_t* pgd</code>等。</p>
<p>vm_area_struct(简称vma)长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> &#123;</span> </span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> vm_start;      <span class="comment">// 区间首地址</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> vm_end;        <span class="comment">// 区间尾地址</span></span><br><span class="line">    <span class="type">pgprot_t</span>      vm_page_prot;  <span class="comment">// 访问控制权限</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_flags;      <span class="comment">// 标志位</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">vm_file</span>;</span>       <span class="comment">// 被映射的文件</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_pgoff;      <span class="comment">// 文件中的偏移量</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前说的将ELF programming header描述的段的虚拟内存做映射，这个映射信息就是用vm_area_struct来记录。一个vm_area_struct记录一个segment, mm_struct里的
vm_area_struct会连起来称为一个链表。</p>
<h3 id="execve"><a href="#execve" class="headerlink" title="execve"></a>execve</h3><p>fork的时候，首先会把PCB复制一份，然后复制页表和PCB中的vma数组。 fork之后要执行新的程序，就需要执行execve这个系统调用。它的主要作用是加载可执行程序并运行。</p>
<p>execve的执行步骤如下所示：</p>
<ul>
<li>清空页表，这样整个进程中的页都变成不存在了，一旦访问这些页，就会发生页中断；</li>
<li>打开待加载执行的文件，在内核中创建代表这个文件的struct file结构；</li>
<li>加载和解析文件头，文件头里描述了这个可执行文件一共有多少section；</li>
<li>创建相应的vma来描述代码段，数据段等，并且将文件的各个section与这些内存区域建立映射关系；</li>
<li>如果program header有INTERP类型的段，则把控制权交给这个指定的动态连接器。</li>
<li>最后跳转到可执行程序的入口处执行。</li>
</ul>
<h3 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h3><p>我们之前看hello的program header时，上面就有这样一条记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INTERP         0x0000000000000238 0x0000000000400238 0x0000000000400238</span><br><span class="line">                 0x000000000000001c 0x000000000000001c  R      1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br></pre></td></tr></table></figure>
<p>这里动态链接器就是&#x2F;lib64&#x2F;ld-linux-x86-64.so.2。 动态链接器的作用是用来对可执行文件中需要动态链接的这些全局符号进行重定位解析，填写GOT表等。
先引用极客时间的一个图，待续</p>
<p><img src="https://static001.geekbang.org/resource/image/fb/ca/fb26425534d40bcec723f2716cb42eca.jpg?wh=2284x1280" alt="动态连接器"></p>
<h3 id="入口Entry-point"><a href="#入口Entry-point" class="headerlink" title="入口Entry point"></a>入口Entry point</h3><p>你可能会认为可执行程序hello的入口是main函数的地址，实际上并不是</p>
<p>我们通过<code>readelf -h hello</code>可以看到hello的ELF header中有一行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Entry point address:               0x400430</span><br></pre></td></tr></table></figure>
<p>即，先执行的是0x400430处的指令，而那里是(objdump -S hello)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000400430 &lt;_start&gt;:</span><br><span class="line">  400430:       31 ed                   xor    %ebp,%ebp</span><br><span class="line">  400432:       49 89 d1                mov    %rdx,%r9</span><br><span class="line">  400435:       5e                      pop    %rsi</span><br><span class="line">  400436:       48 89 e2                mov    %rsp,%rdx</span><br><span class="line">  400439:       48 83 e4 f0             and    $0xfffffffffffffff0,%rsp</span><br><span class="line">  40043d:       50                      push   %rax</span><br><span class="line">  40043e:       54                      push   %rsp</span><br><span class="line">  40043f:       49 c7 c0 20 06 40 00    mov    $0x400620,%r8</span><br><span class="line">  400446:       48 c7 c1 b0 05 40 00    mov    $0x4005b0,%rcx</span><br><span class="line">  40044d:       48 c7 c7 3c 05 40 00    mov    $0x40053c,%rdi</span><br><span class="line">  400454:       e8 b7 ff ff ff          callq  400410 &lt;__libc_start_main@plt&gt;</span><br><span class="line">  400459:       f4                      hlt</span><br><span class="line">  40045a:       66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)</span><br></pre></td></tr></table></figure>

<p>即先调用的是一个_start函数。</p>
<p>gdb</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">panjianning@VM-29-14-ubuntu:~/how$ gdb hello -q</span><br><span class="line">Reading symbols from hello...done.</span><br><span class="line">(gdb) b _start</span><br><span class="line">Breakpoint 1 at 0x400430</span><br><span class="line">(gdb) run</span><br><span class="line">Starting program: /home/panjianning/how/hello</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x0000000000400430 in _start ()</span><br><span class="line">(gdb) print $sp</span><br><span class="line">$1 = (void *) 0x7fffffffe150</span><br><span class="line">(gdb) info proc map</span><br><span class="line">process 47464</span><br><span class="line">Mapped address spaces:</span><br><span class="line"></span><br><span class="line">          Start Addr           End Addr       Size     Offset objfile</span><br><span class="line">            0x400000           0x401000     0x1000        0x0 /home/panjianning/how/hello</span><br><span class="line">            0x600000           0x601000     0x1000        0x0 /home/panjianning/how/hello</span><br><span class="line">            0x601000           0x602000     0x1000     0x1000 /home/panjianning/how/hello</span><br><span class="line">      0x7ffff7a0d000     0x7ffff7bcd000   0x1c0000        0x0 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">      0x7ffff7bcd000     0x7ffff7dcd000   0x200000   0x1c0000 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">      0x7ffff7dcd000     0x7ffff7dd1000     0x4000   0x1c0000 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">      0x7ffff7dd1000     0x7ffff7dd3000     0x2000   0x1c4000 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">      0x7ffff7dd3000     0x7ffff7dd7000     0x4000        0x0</span><br><span class="line">      0x7ffff7dd7000     0x7ffff7dfd000    0x26000        0x0 /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">      0x7ffff7fe1000     0x7ffff7fe4000     0x3000        0x0</span><br><span class="line">      0x7ffff7ff8000     0x7ffff7ffa000     0x2000        0x0 [vvar]</span><br><span class="line">      0x7ffff7ffa000     0x7ffff7ffc000     0x2000        0x0 [vdso]</span><br><span class="line">      0x7ffff7ffc000     0x7ffff7ffd000     0x1000    0x25000 /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">      0x7ffff7ffd000     0x7ffff7ffe000     0x1000    0x26000 /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">      0x7ffff7ffe000     0x7ffff7fff000     0x1000        0x0</span><br><span class="line">      0x7ffffffde000     0x7ffffffff000    0x21000        0x0 [stack]</span><br><span class="line">  0xffffffffff600000 0xffffffffff601000     0x1000        0x0 [vsyscall]</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>待续</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15284947/understanding-gcc-s-output">Understanding gcc -S output | StackOverflow</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7534420/gas-explanation-of-cfi-def-cfa-offset">GAS: Explanation of .cfi_def_cfa_offset | StackOverflow</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48251829/whats-the-difference-between-push-and-pushq-in-att-assembly">What’s the difference between ‘push’ and ‘pushq’ in AT&amp;T assembly | StackOVerflow</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/436308">静态链接：变量与内存地址是如何映射的？ | 极客时间</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">Executable and Linkable Format | Wikipedia</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/CMCDragonkai/10ab53654b2aa6ce55c11cfc5b2432a4">Understanding the Memory Layout of Linux Executables</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/444178">页中断：fork、mmap背后的保护神 | 极客时间</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?src=11&timestamp=1640588787&ver=3521&signature=X*97Kml-8SOYE0gjhYLI7ls0SY6CRGWQzDu7NsO-T05gRPsCxvObiqQm3dW3YeO-Yt5YevIZmV4tBF94RmjULg0zW4Ym7W3STNLGQNKymnK1paUsHbF4Rhb5pcR6UAYO&new=1">一文读懂 Linux 内存分配全过程 | Linux内核那些事</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>一文了解C程序是如何运行起来的</p><p><a href="https://www.heapoverflow.cn/pages/wiki-howcrun/">https://www.heapoverflow.cn/pages/wiki-howcrun/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>面向问题编程</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-04-05</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-04-05</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理</a></div><!--!--><div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6757924689439593" crossOrigin="anonymous"></script><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-6757924689439593" data-ad-slot="2352785969"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/pages/wiki-ducktyping/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">一文了解鸭子类型(Duck typing)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/pages/practice-ali-robustx/"><span class="level-item">阿里达摩院刘春辰：鲁棒时序异常检测与周期识别</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div style="width:100%"><script src="https://giscus.app/client.js" data-repo="thetechstack/thetechstack.github.io" data-repo-id="R_kgDOG6Ti1Q" data-category="Announcements" data-category-id="DIC_kwDOG6Ti1c4COQtm" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" crossOrigin="anonymous" async></script></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#预处理"><span class="level-left"><span class="level-item">1</span><span class="level-item">预处理</span></span></a></li><li><a class="level is-mobile" href="#编译"><span class="level-left"><span class="level-item">2</span><span class="level-item">编译</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#汇编代码分析"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">汇编代码分析</span></span></a></li></ul></li><li><a class="level is-mobile" href="#汇编"><span class="level-left"><span class="level-item">3</span><span class="level-item">汇编</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ELF格式"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">ELF格式</span></span></a></li><li><a class="level is-mobile" href="#分析-text段的内容"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">分析.text段的内容</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#rip相对寻址"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">rip相对寻址</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#链接"><span class="level-left"><span class="level-item">4</span><span class="level-item">链接</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#分析重定位信息"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">分析重定位信息</span></span></a></li><li><a class="level is-mobile" href="#rela-text段"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">.rela.text段</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#rela-text段的offset字段"><span class="level-left"><span class="level-item">4.2.1</span><span class="level-item">.rela.text段的offset字段</span></span></a></li><li><a class="level is-mobile" href="#rela-text段的info字段"><span class="level-left"><span class="level-item">4.2.2</span><span class="level-item">.rela.text段的info字段</span></span></a></li><li><a class="level is-mobile" href="#rela-text段的Attend字段"><span class="level-left"><span class="level-item">4.2.3</span><span class="level-item">.rela.text段的Attend字段</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#运行"><span class="level-left"><span class="level-item">5</span><span class="level-item">运行</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#fork"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">fork</span></span></a></li><li><a class="level is-mobile" href="#execve"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">execve</span></span></a></li><li><a class="level is-mobile" href="#动态链接"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">动态链接</span></span></a></li><li><a class="level is-mobile" href="#入口Entry-point"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">入口Entry point</span></span></a></li></ul></li><li><a class="level is-mobile" href="#参考链接"><span class="level-left"><span class="level-item">6</span><span class="level-item">参考链接</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CPython/"><span class="tag">CPython</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Feed%E6%9C%8D%E5%8A%A1/"><span class="tag">Feed服务</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Knative/"><span class="tag">Knative</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag">23</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E7%BD%91%E7%BB%9C/"><span class="tag">Linux网络</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Serverless/"><span class="tag">Serverless</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Yarn/"><span class="tag">Yarn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7/"><span class="tag">分布式一致性</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9C%A8%E7%A6%BB%E7%BA%BF%E6%B7%B7%E9%83%A8/"><span class="tag">在离线混部</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"><span class="tag">大数据</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/"><span class="tag">时间序列</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%99%BA%E8%83%BD%E8%BF%90%E7%BB%B4/"><span class="tag">智能运维</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"><span class="tag">编译原理</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96/"><span class="tag">网络虚拟化</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/"><span class="tag">虚拟机</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AF%AD%E8%A8%80%E7%89%B9%E6%80%A7/"><span class="tag">语言特性</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.jpg"></figure><p class="is-size-6 is-block">公众号：面向问题编程</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">63</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">17</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3/"><span class="level-start"><span class="level-item">一文了解</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5/"><span class="level-start"><span class="level-item">技术实践</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84/"><span class="level-start"><span class="level-item">技术架构</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BB%BC%E8%BF%B0/"><span class="level-start"><span class="level-item">综述</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%97%AE%E9%A2%98/"><span class="level-start"><span class="level-item">问题</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="面向问题编程" height="28"></a><p class="is-size-7"><span>&copy; 2022 面向问题编程</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lg-zoom@1.3.0/dist/lg-zoom.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>